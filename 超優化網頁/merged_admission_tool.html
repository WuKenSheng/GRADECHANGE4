
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å‡å­¸è©•ä¼°å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div id="evaluationList"></div>

<script>
  function renderEvaluationList() {
    const elist = document.getElementById('evaluationList');
    elist.innerHTML = '';
    evaluationData.forEach((dept, idx) => {
      const minScore = parseFloat(dept['æ™®é€šç”ŸéŒ„å–åˆ†æ•¸']) || 0;
      let totalHigh = 0;
      let totalLow = 0;
      let advancedWeightSum = 0;

      const mapping = {
        'åœ‹æ–‡': 'åœ‹å€ç‡', 'è‹±æ–‡': 'è‹±å€ç‡', 'æ•¸A': 'æ•¸Aå€ç‡',
        'æ•¸B': 'æ•¸Bå€ç‡', 'ç¤¾æœƒ': 'ç¤¾æœƒå€ç‡', 'è‡ªç„¶': 'è‡ªç„¶å€ç‡'
      };

      for (let sub in mapping) {
        const weightKey = mapping[sub];
        const weight = parseFloat(dept[weightKey] || 0);
        const score = userScores[sub] || { min: 0, max: 0 };
        totalHigh += score.max * weight;
        totalLow += score.min * weight;
      }

      advancedSubjects.forEach(sub => {
        const weight = parseFloat(dept[sub + 'å€ç‡'] || 0);
        advancedWeightSum += weight;
      });

      const avgMin = ((minScore - totalHigh) / (advancedWeightSum || 1)).toFixed(2);
      const avgMax = ((minScore - totalLow) / (advancedWeightSum || 1)).toFixed(2);

      elist.innerHTML += `
        <div><strong>${idx+1}. ${dept['å¹´åº¦']} ${dept['æ ¡å']} ${dept['ç³»çµ„å']}</strong><br>
        å„ç§‘å€ç‡ï¼š${subjectWeights.map(w => `${w}: ${dept[w] || 0}`).join(' ï½œ ')}<br>
        æœ€ä½éŒ„å–åˆ†æ•¸ï¼š${minScore} ï½œ éŒ„å–äººæ•¸ï¼š${dept['éŒ„å–äººæ•¸'] || 'N/A'}<br>
        ğŸ”¹ æœ€ä½åˆ†ç§‘å–®ç§‘å¹³å‡ç´šåˆ†ï¼š${avgMin} ï½œ ğŸ”¸ æœ€é«˜åˆ†ç§‘å–®ç§‘å¹³å‡ç´šåˆ†ï¼š${avgMax}<br>
        <button onclick="removeEvaluation(${idx})">ç§»é™¤</button><hr></div>`;
    });
    elist.innerHTML += `<button onclick="generatePDF()">ğŸ“„ ç”¢ç”Ÿ PDF å ±è¡¨</button>`;
  }

  async function generatePDF() {
    const {{ jsPDF }} = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("å‡å­¸è©•ä¼°æ¸…å–®å ±è¡¨", 10, 10);
    let y = 20;

    evaluationData.forEach((dept, idx) => {
      const minScore = parseFloat(dept['æ™®é€šç”ŸéŒ„å–åˆ†æ•¸']) || 0;
      let totalHigh = 0, totalLow = 0, advancedWeightSum = 0;
      const mapping = {
        'åœ‹æ–‡': 'åœ‹å€ç‡', 'è‹±æ–‡': 'è‹±å€ç‡', 'æ•¸A': 'æ•¸Aå€ç‡',
        'æ•¸B': 'æ•¸Bå€ç‡', 'ç¤¾æœƒ': 'ç¤¾æœƒå€ç‡', 'è‡ªç„¶': 'è‡ªç„¶å€ç‡'
      };
      for (let sub in mapping) {
        const weight = parseFloat(dept[mapping[sub]] || 0);
        const score = userScores[sub] || { min: 0, max: 0 };
        totalHigh += score.max * weight;
        totalLow += score.min * weight;
      }
      advancedSubjects.forEach(sub => {
        const weight = parseFloat(dept[sub + 'å€ç‡'] || 0);
        advancedWeightSum += weight;
      });
      const avgMin = ((minScore - totalHigh) / (advancedWeightSum || 1)).toFixed(2);
      const avgMax = ((minScore - totalLow) / (advancedWeightSum || 1)).toFixed(2);

      const lines = [
        `${idx + 1}. ${dept['å¹´åº¦']} ${dept['æ ¡å']} ${dept['ç³»çµ„å']}`,
        `æœ€ä½éŒ„å–åˆ†æ•¸: ${minScore}ï¼ŒéŒ„å–äººæ•¸: ${dept['éŒ„å–äººæ•¸'] || 'N/A'}`,
        `æœ€ä½å¹³å‡ç´šåˆ†: ${avgMin}ï¼Œæœ€é«˜å¹³å‡ç´šåˆ†: ${avgMax}`,
        `å„ç§‘å€ç‡: ${subjectWeights.map(w => `${w}:${dept[w] || 0}`).join('ï½œ')}`
      ];

      lines.forEach(line => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.text(line, 10, y);
        y += 8;
      });

      y += 4;
    });

    doc.save("å‡å­¸è©•ä¼°å ±è¡¨.pdf");
  }
</script>

</body>
</html>
